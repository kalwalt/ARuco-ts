<!DOCTYPE html>
<html>
  <head>
    <title>Threshold Test</title>
  </head>
  <body>
    <h1>Threshold Test Debug</h1>
    <canvas id="test" width="100" height="100"></canvas>
    <pre id="log"></pre>

    <script src="../dist/ARuco.js"></script>
    <script>
      //import { CV, Image } from '../dist/ARuco.js';

      const log = document.getElementById("log");
      function print(msg) {
        log.textContent += msg + "\n";
        console.log(msg);
      }

      print("=== Testing Image Constructor ===");

      // Test 1: Empty constructor
      try {
        const img1 = new CV.Image(100, 100);
        print(`✅ new Image(100, 100) created`);
        print(`   width: ${img1.width}`);
        print(`   height: ${img1.height}`);
        print(
          `   data: ${img1.data ? img1.data.constructor.name : "undefined"}`
        );
        print(`   data.length: ${img1.data ? img1.data.length : "N/A"}`);
      } catch (e) {
        print(`❌ Error creating Image: ${e.message}`);
      }

      print("\n=== Testing with Data ===");

      // Test 2: With data
      try {
        const data = new Uint8ClampedArray(100 * 100);
        for (let i = 0; i < data.length; i++) {
          data[i] = Math.floor((i / data.length) * 255);
        }

        const src = new CV.Image(100, 100, data);
        print(`✅ new Image(100, 100, data) created`);
        print(`   data.length: ${src.data.length}`);
        print(`   First 5 values: [${src.data.slice(0, 5).join(", ")}]`);

        // Now test threshold
        const dst = new CV.Image(100, 100);
        print(`\n=== Testing threshold() ===`);
        print(`src.data exists: ${!!src.data}`);
        print(`dst.data exists: ${!!dst.data}`);
        print(`dst.data.length: ${dst.data ? dst.data.length : "N/A"}`);

        if (!dst.data) {
          print(`❌ PROBLEM: dst.data is undefined!`);
          print(
            `   This means the Image constructor didn't initialize data correctly.`
          );

          // Try manual fix
          print(`\n=== Trying Manual Fix ===`);
          dst.data = new Uint8ClampedArray(100 * 100);
          print(`✅ Manually created dst.data`);
        }

        CV.threshold(src, dst, 128);
        print(`✅ threshold() completed`);
        print(`   Output first 5: [${dst.data.slice(0, 5).join(", ")}]`);
        print(`   Output last 5: [${dst.data.slice(-5).join(", ")}]`);
      } catch (e) {
        print(`❌ Error: ${e.message}`);
        print(`   Stack: ${e.stack}`);
      }
    </script>
  </body>
</html>
